!function(t){"use strict";var o={},n={},e=null,r=0,a={},s={},i={};t.importScripts("utils.js"),o.setStructure=function(t){var o,n,a=t.bonds,s=a.length;for(o=0,n=0;s>o;o++)"x"===a[n].type?a.push(a.splice(n,1)[0]):n++;return r=n,e=t},o.updateStructure=function(){t.postMessage({method:"updateStructure",data:e})},o.totalEnergy=function(){return n.totalEnergy()},o.gradient=function(){return a.alloc(),n.gradient(),a.dispose(),n.norm},o.evolve=function(t){return n.evolveParams=t,n.evolve(),o.updateStructure(),{energy:n.totalEnergy(),norm:n.norm}},o.reconnectPairs=function(t){var a,s,i,u,m,l,c=t.pair.match(/[A-Z][^A-Z]*/g),d=t.cutoff*t.cutoff,f=e.atoms,h=f.length,p=e.bonds;for(i=0;h>i;i++){if(f[i].el===c[0])l=c[1];else{if(f[i].el!==c[1])continue;l=c[0]}for(u=i+1;h>u;u++)if(f[u].el===l){for(m=r,a=p[m],s=p.length;s>m&&!(a.iAtm===i&&a.jAtm===u||a.iAtm===u&&a.jAtm===i);a=p[++m]);n.sqrDistance(i,u)>d?a&&p.splice(m,1):a||p.push({iAtm:i,jAtm:u,type:"x"})}}o.updateStructure()},o.collectStats=function(){var t,o,r,a,s,i=e.atoms,u=e.bonds,m={};for(m.name=e.name,m.atomCount=o=i.length,m.atoms={},t=0;o>t;t++)m.atoms.hasOwnProperty(i[t].el)?m.atoms[i[t].el]++:m.atoms[i[t].el]=1;for(m.bondCount=o=u.length,m.bonds={},t=0;o>t;t++)r="x"===u[t].type?"x-":"",a=r+i[u[t].jAtm].el+i[u[t].iAtm].el,m.bonds.hasOwnProperty(a)||(a=r+i[u[t].iAtm].el+i[u[t].jAtm].el,m.bonds.hasOwnProperty(a)||(m.bonds[a]={count:0,avgLen:0,avgEnergy:0,totEnergy:0})),s=n.distance(u[t].iAtm,u[t].jAtm),m.bonds[a].count++,m.bonds[a].avgLen+=s,m.bonds[a].totEnergy+=n.morse(u[t].potential,s);for(a in m.bonds)m.bonds.hasOwnProperty(a)&&(m.bonds[a].avgLen/=m.bonds[a].count,m.bonds[a].avgEnergy=m.bonds[a].totEnergy/m.bonds[a].count);return m.potentials=e.potentials,m.totalEnergy=n.totalEnergy(),m},t.onmessage=function(n){var e=n.data&&n.data.method;"function"==typeof o[e]&&t.postMessage({method:e,data:o[e].call(o,n.data.data)})},a.alloc=s.alloc=function(){var t=e.atoms.length;this.x=new Float32Array(t),this.y=new Float32Array(t),this.z=new Float32Array(t)},a.dispose=s.dispose=function(){this.x=this.y=this.z=null},i.alloc=function(t){this.data={E:new Float32Array(t),grad:new Float32Array(t),dt:new Float32Array(t)}},i.dispose=function(){this.data=null},i.write=function(t){var o=this.data;o.E[t]=n.totalEnergy(),o.grad[t]=n.norm,o.dt[t]=n.timeStep()},n.sqrDistance=function(t,o){var n=e.atoms[t],r=e.atoms[o],a=n.x-r.x,s=n.y-r.y,i=n.z-r.z;return a*a+s*s+i*i},n.distance=function(t,o){return Math.sqrt(n.sqrDistance(t,o))},n.morse=function(t,o){var n=Math.exp(t.b*(t.R0-o));return t.D0*n*(n-2)},n.derivative=function(t,o){var n=t.D0*Math.exp(2*t.b*t.R0),e=-2*t.b,r=-2*Math.sqrt(t.D0*n),a=Math.exp(-t.b*o);return e*a*(n*a+.5*r)},n.gradComponent=function(t,o,r){var a=n.distance(t,o),s=n.derivative(e.bonds[r].potential,a)/a,i=e.atoms[t],u=e.atoms[o];return{x:s*(i.x-u.x),y:s*(i.y-u.y),z:s*(i.z-u.z)}},n.totalEnergy=function(){var t,o,r=0,a=e.bonds;for(t=0,o=a.length;o>t;t++)r+=n.morse(a[t].potential,n.distance(a[t].iAtm,a[t].jAtm));return r},n.gradient=function(){var o,r,s,i,u,m,l,c=e.atoms,d=c.length,f=e.bonds,h=f.length,p=t.OE.utils;for(n.norm=n.sumSqr=n.rootSumSqr=0,i=0;d>i;i++){for(a.x[i]=a.y[i]=a.z[i]=0,m=0;h>m;m++){if(f[m].iAtm===i)u=f[m].jAtm;else{if(f[m].jAtm!==i)continue;u=f[m].iAtm}o=n.gradComponent(i,u,m),a.x[i]+=o.x,a.y[i]+=o.y,a.z[i]+=o.z}r=a.x[i]*a.x[i]+a.y[i]*a.y[i]+a.z[i]*a.z[i],l=p.getAtomicMass(c[i].el),n.sumSqr+=r/l,n.rootSumSqr+=r/(l*l),n.norm+=r}for(n.rootSumSqr=Math.sqrt(n.rootSumSqr),n.norm=Math.sqrt(n.norm),s=1/n.norm,i=0;d>i;i++)a.x[i]*=s,a.y[i]*=s,a.z[i]*=s;return n.norm},n.stochGradient=function(){var o,r,i,u,m,l,c,d,f,h,p=e.atoms,y=p.length,g=e.bonds,v=g.length,x=t.OE.utils;for(i=n.norm=n.sumSqr=n.rootSumSqr=0,c=0;y>c;c++){for(a.x[c]=a.y[c]=a.z[c]=0,f=0;v>f;f++){if(g[f].iAtm===c)d=g[f].jAtm;else{if(g[f].jAtm!==c)continue;d=g[f].iAtm}o=n.gradComponent(c,d,f),a.x[c]+=o.x,a.y[c]+=o.y,a.z[c]+=o.z}r=a.x[c]*a.x[c]+a.y[c]*a.y[c]+a.z[c]*a.z[c],h=x.getAtomicMass(p[c].el),n.sumSqr+=r/h,n.rootSumSqr+=r/(h*h),n.norm+=r,s.x[c]=50-100*Math.random(),s.y[c]=50-100*Math.random(),s.z[c]=50-100*Math.random(),i+=s.x[c]*s.x[c]+s.y[c]*s.y[c]+s.z[c]*s.z[c]}for(n.rootSumSqr=Math.sqrt(n.rootSumSqr),n.norm=Math.sqrt(n.norm),i=Math.sqrt(i),l=0,u=1/n.norm,m=1/i,c=0;y>c;c++)a.x[c]*=u,a.y[c]*=u,a.z[c]*=u,s.x[c]*=m,s.y[c]*=m,s.z[c]*=m,a.x[c]+=s.x[c],a.y[c]+=s.y[c],a.z[c]+=s.z[c],l+=a.x[c]*a.x[c]+a.y[c]*a.y[c]+a.z[c]*a.z[c];for(l=Math.sqrt(l),u=1/l,c=0;y>c;c++)a.x[c]*=u,a.y[c]*=u,a.z[c]*=u;return n.norm},n.timeStep=function(){return 1.636886e-16*Math.sqrt(e.atoms.length*n.evolveParams.temperature/n.sumSqr)},n.tuneEvolver=function(){var o=n.evolveParams,e=o.logInterval,r={},u=[],m=[],l=[];return u.push(a.alloc.bind(a)),m.push(o.stoch?n.stochGradient.bind(n):n.gradient.bind(n)),l.push(a.dispose.bind(a)),o.stoch&&(u.push(s.alloc.bind(s)),l.push(s.dispose.bind(s))),e&&(u.push(i.alloc.bind(i,Math.floor(o.stepCount/e))),m.push(function(t){t%e===0&&i.write(t/e)}),l.push(function(){t.postMessage({method:"evolve.log",data:i.data}),i.dispose()})),r.initialize=function(){u.forEach(function(t){t()})},r.step=function(t){for(var o=0,n=m.length;n>o;o++)m[o](t)},r.finalize=function(){l.forEach(function(t){t()})},r},n.evolve=function(){var o,r,s,i,u=n.evolveParams,m=n.tuneEvolver(),l=e.atoms,c=l.length,d=12926e-8*c*u.temperature,f=Math.ceil(u.stepCount/100),h=100/u.stepCount,p={method:"evolve.progress"};for(m.initialize(),m.step(),o=0,r=u.stepCount;r>o;o++){for(s=d*n.rootSumSqr/n.sumSqr,i=0;c>i;i++)l[i].x-=s*a.x[i],l[i].y-=s*a.y[i],l[i].z-=s*a.z[i];o%f===0&&(p.data=o*h,t.postMessage(p)),m.step(o)}m.finalize()}}(this);