!function(t){"use strict";var o={},n={},r=null,e=0,a={},s={},i={};t.importScripts("utils.js"),o.setStructure=function(t){var o,n,a=t.bonds,s=a.length;for(o=0,n=0;s>o;o++)"x"===a[n].type?a.push(a.splice(n,1)[0]):n++;return e=n,r=t},o.updateStructure=function(){t.postMessage({method:"updateStructure",data:r})},o.totalEnergy=function(){return n.totalEnergy()},o.gradient=function(){return a.alloc(),n.gradient(),a.dispose(),n.norm},o.evolve=function(t){return n.evolveParams=t,n.evolve(),o.updateStructure(),{energy:n.totalEnergy(),norm:n.norm}},o.reconnectPairs=function(t){var a,s,i,u,l,m,c=t.pair.match(/[A-Z][^A-Z]*/g),d=t.cutoff*t.cutoff,f=r.atoms,h=f.length,p=r.bonds;for(i=0;h>i;i++){if(f[i].el===c[0])m=c[1];else{if(f[i].el!==c[1])continue;m=c[0]}for(u=i+1;h>u;u++)if(f[u].el===m){for(l=e,a=p[l],s=p.length;s>l&&!(a.iAtm===i&&a.jAtm===u||a.iAtm===u&&a.jAtm===i);a=p[++l]);n.sqrDistance(i,u)>d?a&&p.splice(l,1):a||p.push({iAtm:i,jAtm:u,type:"x"})}}o.updateStructure()},o.collectStats=function(){var t,o,e,a,s,i=r.atoms,u=r.bonds,l={};for(l.atomCount=o=i.length,l.atoms={},t=0;o>t;t++)l.atoms.hasOwnProperty(i[t].el)?l.atoms[i[t].el]++:l.atoms[i[t].el]=1;for(l.bondCount=o=u.length,l.bonds={},t=0;o>t;t++)e="x"===u[t].type?"x-":"",a=e+i[u[t].jAtm].el+i[u[t].iAtm].el,l.bonds.hasOwnProperty(a)||(a=e+i[u[t].iAtm].el+i[u[t].jAtm].el,l.bonds.hasOwnProperty(a)||(l.bonds[a]={count:0,avgLen:0,avgEnergy:0,totEnergy:0})),s=n.distance(u[t].iAtm,u[t].jAtm),l.bonds[a].count++,l.bonds[a].avgLen+=s,l.bonds[a].totEnergy+=n.morse(u[t].potential,s);for(a in l.bonds)l.bonds.hasOwnProperty(a)&&(l.bonds[a].avgLen/=l.bonds[a].count,l.bonds[a].avgEnergy=l.bonds[a].totEnergy/l.bonds[a].count);return l.potentials=r.potentials,l.totalEnergy=n.totalEnergy(),l},t.onmessage=function(n){var r=n.data&&n.data.method;"function"==typeof o[r]&&t.postMessage({method:r,data:o[r].call(o,n.data.data)})},a.alloc=s.alloc=function(){var t=r.atoms.length;this.x=new Float32Array(t),this.y=new Float32Array(t),this.z=new Float32Array(t)},a.dispose=s.dispose=function(){this.x=this.y=this.z=null},i.alloc=function(t){this.data={E:new Float32Array(t),grad:new Float32Array(t),dt:new Float32Array(t)}},i.dispose=function(){this.data=null},i.write=function(t){var o=this.data;o.E[t]=n.totalEnergy(),o.grad[t]=n.norm,o.dt[t]=n.timeStep()},n.sqrDistance=function(t,o){var n=r.atoms[t],e=r.atoms[o],a=n.x-e.x,s=n.y-e.y,i=n.z-e.z;return a*a+s*s+i*i},n.distance=function(t,o){return Math.sqrt(n.sqrDistance(t,o))},n.morse=function(t,o){var n=Math.exp(t.b*(t.R0-o));return t.D0*n*(n-2)},n.derivative=function(t,o){var n=t.D0*Math.exp(2*t.b*t.R0),r=-2*t.b,e=-2*Math.sqrt(t.D0*n),a=Math.exp(-t.b*o);return r*a*(n*a+.5*e)},n.gradComponent=function(t,o,e){var a=n.distance(t,o),s=n.derivative(r.bonds[e].potential,a)/a,i=r.atoms[t],u=r.atoms[o];return{x:s*(i.x-u.x),y:s*(i.y-u.y),z:s*(i.z-u.z)}},n.totalEnergy=function(){var t,o,e=0,a=r.bonds;for(t=0,o=a.length;o>t;t++)e+=n.morse(a[t].potential,n.distance(a[t].iAtm,a[t].jAtm));return e},n.gradient=function(){var o,e,s,i,u,l,m,c=r.atoms,d=c.length,f=r.bonds,h=f.length,p=t.OE.utils;for(n.norm=n.sumSqr=n.rootSumSqr=0,i=0;d>i;i++){for(a.x[i]=a.y[i]=a.z[i]=0,l=0;h>l;l++){if(f[l].iAtm===i)u=f[l].jAtm;else{if(f[l].jAtm!==i)continue;u=f[l].iAtm}o=n.gradComponent(i,u,l),a.x[i]+=o.x,a.y[i]+=o.y,a.z[i]+=o.z}e=a.x[i]*a.x[i]+a.y[i]*a.y[i]+a.z[i]*a.z[i],m=p.getAtomicMass(c[i].el),n.sumSqr+=e/m,n.rootSumSqr+=e/(m*m),n.norm+=e}for(n.rootSumSqr=Math.sqrt(n.rootSumSqr),n.norm=Math.sqrt(n.norm),s=1/n.norm,i=0;d>i;i++)a.x[i]*=s,a.y[i]*=s,a.z[i]*=s;return n.norm},n.stochGradient=function(){var o,e,i,u,l,m,c,d,f,h,p=r.atoms,y=p.length,g=r.bonds,v=g.length,x=t.OE.utils;for(i=n.norm=n.sumSqr=n.rootSumSqr=0,c=0;y>c;c++){for(a.x[c]=a.y[c]=a.z[c]=0,f=0;v>f;f++){if(g[f].iAtm===c)d=g[f].jAtm;else{if(g[f].jAtm!==c)continue;d=g[f].iAtm}o=n.gradComponent(c,d,f),a.x[c]+=o.x,a.y[c]+=o.y,a.z[c]+=o.z}e=a.x[c]*a.x[c]+a.y[c]*a.y[c]+a.z[c]*a.z[c],h=x.getAtomicMass(p[c].el),n.sumSqr+=e/h,n.rootSumSqr+=e/(h*h),n.norm+=e,s.x[c]=50-100*Math.random(),s.y[c]=50-100*Math.random(),s.z[c]=50-100*Math.random(),i+=s.x[c]*s.x[c]+s.y[c]*s.y[c]+s.z[c]*s.z[c]}for(n.rootSumSqr=Math.sqrt(n.rootSumSqr),n.norm=Math.sqrt(n.norm),i=Math.sqrt(i),m=0,u=1/n.norm,l=1/i,c=0;y>c;c++)a.x[c]*=u,a.y[c]*=u,a.z[c]*=u,s.x[c]*=l,s.y[c]*=l,s.z[c]*=l,a.x[c]+=s.x[c],a.y[c]+=s.y[c],a.z[c]+=s.z[c],m+=a.x[c]*a.x[c]+a.y[c]*a.y[c]+a.z[c]*a.z[c];for(m=Math.sqrt(m),u=1/m,c=0;y>c;c++)a.x[c]*=u,a.y[c]*=u,a.z[c]*=u;return n.norm},n.timeStep=function(){return 1.636886e-16*Math.sqrt(r.atoms.length*n.evolveParams.temperature/n.sumSqr)},n.tuneEvolver=function(){var o=n.evolveParams,r=o.logInterval,e={},u=[],l=[],m=[];return u.push(a.alloc.bind(a)),l.push(o.stoch?n.stochGradient.bind(n):n.gradient.bind(n)),m.push(a.dispose.bind(a)),o.stoch&&(u.push(s.alloc.bind(s)),m.push(s.dispose.bind(s))),r&&(u.push(i.alloc.bind(i,Math.floor(o.stepCount/r))),l.push(function(t){t%r===0&&i.write(t/r)}),m.push(function(){t.postMessage({method:"evolve.log",data:i.data}),i.dispose()})),e.initialize=function(){u.forEach(function(t){t()})},e.step=function(t){for(var o=0,n=l.length;n>o;o++)l[o](t)},e.finalize=function(){m.forEach(function(t){t()})},e},n.evolve=function(){var o,e,s,i,u=n.evolveParams,l=n.tuneEvolver(),m=r.atoms,c=m.length,d=12926e-8*c*u.temperature,f=Math.ceil(u.stepCount/100),h=100/u.stepCount,p={method:"evolve.progress"};for(l.initialize(),l.step(),o=0,e=u.stepCount;e>o;o++){for(s=d*n.rootSumSqr/n.sumSqr,i=0;c>i;i++)m[i].x-=s*a.x[i],m[i].y-=s*a.y[i],m[i].z-=s*a.z[i];o%f===0&&(p.data=o*h,t.postMessage(p)),l.step(o)}l.finalize()}}(this);