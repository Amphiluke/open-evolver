!function(t){"use strict";var r={},n={},e=null,o=0,a={};t.importScripts("utils.js"),r.setStructure=function(t){var r,n,i=t.bonds,s=i.length,u=t.atoms.length;for(r=0,n=0;s>r;r++)"x"===i[n].type?i.push(i.splice(n,1)[0]):n++;return o=n,e=t,a.x=new Float32Array(u),a.y=new Float32Array(u),a.z=new Float32Array(u),e},r.updateStructure=function(){t.postMessage({method:"updateStructure",data:e})},r.totalEnergy=function(){return n.totalEnergy()},r.gradient=function(){return n.gradient()},r.reconnectPairs=function(t){var a,i,s,u,m,c,f=t.pair.match(/[A-Z][^A-Z]*/g),l=t.cutoff*t.cutoff,d=e.atoms,p=d.length,h=e.bonds;for(s=0;p>s;s++){if(d[s].el===f[0])c=f[1];else{if(d[s].el!==f[1])continue;c=f[0]}for(u=s+1;p>u;u++)if(d[u].el===c){for(m=o,a=h[m],i=h.length;i>m&&!(a.iAtm===s&&a.jAtm===u||a.iAtm===u&&a.jAtm===s);a=h[++m]);n.sqrDistance(s,u)>l?a&&h.splice(m,1):a||h.push({iAtm:s,jAtm:u,type:"x"})}}r.updateStructure()},t.onmessage=function(n){var e=n.data&&n.data.method;"function"==typeof r[e]&&t.postMessage({method:e,data:r[e].call(r,n.data.data)})},n.sqrDistance=function(t,r){var n=e.atoms[t],o=e.atoms[r],a=n.x-o.x,i=n.y-o.y,s=n.z-o.z;return a*a+i*i+s*s},n.distance=function(t,r){return Math.sqrt(n.sqrDistance(t,r))},n.morse=function(t,r){var n=Math.exp(t.b*(t.R0-r));return t.D0*n*(n-2)},n.derivative=function(t,r){var n=t.D0*Math.exp(2*t.b*t.R0),e=-2*t.b,o=-2*Math.sqrt(t.D0*n),a=Math.exp(-t.b*r);return e*a*(n*a+.5*o)},n.gradComponent=function(t,r,o){var a=n.distance(t,r),i=n.derivative(e.bonds[o].potential,a)/a,s=e.atoms[t],u=e.atoms[r];return{x:i*(s.x-u.x),y:i*(s.y-u.y),z:i*(s.z-u.z)}},n.totalEnergy=function(){var t,r,o=0,a=e.bonds;for(t=0,r=a.length;r>t;t++)o+=n.morse(a[t].potential,n.distance(a[t].iAtm,a[t].jAtm));return o},n.gradient=function(){var r,o,i,s,u,m,c,f=e.atoms,l=f.length,d=e.bonds,p=d.length,h=t.OE.utils;for(n.norm=n.sumSqr=n.rootSumSqr=0,s=0;l>s;s++){for(a.x[s]=a.y[s]=a.z[s]=0,m=0;p>m;m++){if(d[m].iAtm===s)u=d[m].jAtm;else{if(d[m].jAtm!==s)continue;u=d[m].iAtm}r=n.gradComponent(s,u,m),a.x[s]+=r.x,a.y[s]+=r.y,a.z[s]+=r.z}o=a.x[s]*a.x[s]+a.y[s]*a.y[s]+a.z[s]*a.z[s],c=h.getAtomicMass(f[s].el),n.sumSqr+=o/c,n.rootSumSqr+=o/(c*c),n.norm+=o}for(n.rootSumSqr=Math.sqrt(n.rootSumSqr),n.norm=Math.sqrt(n.norm),i=1/n.norm,s=0;l>s;s++)a.x[s]*=i,a.y[s]*=i,a.z[s]*=i;return n.norm}}(this);