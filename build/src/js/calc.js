!function(t){"use strict";var o={},n={},r=null,e=0,a={},s={};t.importScripts("utils.js"),o.setStructure=function(t){var o,n,a=t.bonds,s=a.length;for(o=0,n=0;s>o;o++)"x"===a[n].type?a.push(a.splice(n,1)[0]):n++;return e=n,r=t},o.updateStructure=function(){t.postMessage({method:"updateStructure",data:r})},o.totalEnergy=function(){return n.totalEnergy()},o.gradient=function(){return a.alloc(),n.gradient(),a.dispose(),n.norm},o.evolve=function(t){return n.evolve(t.stepCount,t.temperature,t.stoch),o.updateStructure(),{energy:n.totalEnergy(),norm:n.norm}},o.reconnectPairs=function(t){var a,s,i,m,u,l,c=t.pair.match(/[A-Z][^A-Z]*/g),d=t.cutoff*t.cutoff,y=r.atoms,f=y.length,h=r.bonds;for(i=0;f>i;i++){if(y[i].el===c[0])l=c[1];else{if(y[i].el!==c[1])continue;l=c[0]}for(m=i+1;f>m;m++)if(y[m].el===l){for(u=e,a=h[u],s=h.length;s>u&&!(a.iAtm===i&&a.jAtm===m||a.iAtm===m&&a.jAtm===i);a=h[++u]);n.sqrDistance(i,m)>d?a&&h.splice(u,1):a||h.push({iAtm:i,jAtm:m,type:"x"})}}o.updateStructure()},o.collectStats=function(){var t,o,e,a,s,i=r.atoms,m=r.bonds,u={};for(u.atomCount=o=i.length,u.atoms={},t=0;o>t;t++)u.atoms.hasOwnProperty(i[t].el)?u.atoms[i[t].el]++:u.atoms[i[t].el]=1;for(u.bondCount=o=m.length,u.bonds={},t=0;o>t;t++)e="x"===m[t].type?"x-":"",a=e+i[m[t].jAtm].el+i[m[t].iAtm].el,u.bonds.hasOwnProperty(a)||(a=e+i[m[t].iAtm].el+i[m[t].jAtm].el,u.bonds.hasOwnProperty(a)||(u.bonds[a]={count:0,avgLen:0,avgEnergy:0,totEnergy:0})),s=n.distance(m[t].iAtm,m[t].jAtm),u.bonds[a].count++,u.bonds[a].avgLen+=s,u.bonds[a].totEnergy+=n.morse(m[t].potential,s);for(a in u.bonds)u.bonds.hasOwnProperty(a)&&(u.bonds[a].avgLen/=u.bonds[a].count,u.bonds[a].avgEnergy=u.bonds[a].totEnergy/u.bonds[a].count);return u.potentials=r.potentials,u.totalEnergy=n.totalEnergy(),u},t.onmessage=function(n){var r=n.data&&n.data.method;"function"==typeof o[r]&&t.postMessage({method:r,data:o[r].call(o,n.data.data)})},a.alloc=s.alloc=function(){var t=r.atoms.length;this.x=new Float32Array(t),this.y=new Float32Array(t),this.z=new Float32Array(t)},a.dispose=s.dispose=function(){this.x=this.y=this.z=null},n.sqrDistance=function(t,o){var n=r.atoms[t],e=r.atoms[o],a=n.x-e.x,s=n.y-e.y,i=n.z-e.z;return a*a+s*s+i*i},n.distance=function(t,o){return Math.sqrt(n.sqrDistance(t,o))},n.morse=function(t,o){var n=Math.exp(t.b*(t.R0-o));return t.D0*n*(n-2)},n.derivative=function(t,o){var n=t.D0*Math.exp(2*t.b*t.R0),r=-2*t.b,e=-2*Math.sqrt(t.D0*n),a=Math.exp(-t.b*o);return r*a*(n*a+.5*e)},n.gradComponent=function(t,o,e){var a=n.distance(t,o),s=n.derivative(r.bonds[e].potential,a)/a,i=r.atoms[t],m=r.atoms[o];return{x:s*(i.x-m.x),y:s*(i.y-m.y),z:s*(i.z-m.z)}},n.totalEnergy=function(){var t,o,e=0,a=r.bonds;for(t=0,o=a.length;o>t;t++)e+=n.morse(a[t].potential,n.distance(a[t].iAtm,a[t].jAtm));return e},n.gradient=function(){var o,e,s,i,m,u,l,c=r.atoms,d=c.length,y=r.bonds,f=y.length,h=t.OE.utils;for(n.norm=n.sumSqr=n.rootSumSqr=0,i=0;d>i;i++){for(a.x[i]=a.y[i]=a.z[i]=0,u=0;f>u;u++){if(y[u].iAtm===i)m=y[u].jAtm;else{if(y[u].jAtm!==i)continue;m=y[u].iAtm}o=n.gradComponent(i,m,u),a.x[i]+=o.x,a.y[i]+=o.y,a.z[i]+=o.z}e=a.x[i]*a.x[i]+a.y[i]*a.y[i]+a.z[i]*a.z[i],l=h.getAtomicMass(c[i].el),n.sumSqr+=e/l,n.rootSumSqr+=e/(l*l),n.norm+=e}for(n.rootSumSqr=Math.sqrt(n.rootSumSqr),n.norm=Math.sqrt(n.norm),s=1/n.norm,i=0;d>i;i++)a.x[i]*=s,a.y[i]*=s,a.z[i]*=s;return n.norm},n.stochGradient=function(){var o,e,i,m,u,l,c,d,y,f,h=r.atoms,g=h.length,p=r.bonds,x=p.length,v=t.OE.utils;for(i=n.norm=n.sumSqr=n.rootSumSqr=0,c=0;g>c;c++){for(a.x[c]=a.y[c]=a.z[c]=0,y=0;x>y;y++){if(p[y].iAtm===c)d=p[y].jAtm;else{if(p[y].jAtm!==c)continue;d=p[y].iAtm}o=n.gradComponent(c,d,y),a.x[c]+=o.x,a.y[c]+=o.y,a.z[c]+=o.z}e=a.x[c]*a.x[c]+a.y[c]*a.y[c]+a.z[c]*a.z[c],f=v.getAtomicMass(h[c].el),n.sumSqr+=e/f,n.rootSumSqr+=e/(f*f),n.norm+=e,s.x[c]=50-100*Math.random(),s.y[c]=50-100*Math.random(),s.z[c]=50-100*Math.random(),i+=s.x[c]*s.x[c]+s.y[c]*s.y[c]+s.z[c]*s.z[c]}for(n.rootSumSqr=Math.sqrt(n.rootSumSqr),n.norm=Math.sqrt(n.norm),i=Math.sqrt(i),l=0,m=1/n.norm,u=1/i,c=0;g>c;c++)a.x[c]*=m,a.y[c]*=m,a.z[c]*=m,s.x[c]*=u,s.y[c]*=u,s.z[c]*=u,a.x[c]+=s.x[c],a.y[c]+=s.y[c],a.z[c]+=s.z[c],l+=a.x[c]*a.x[c]+a.y[c]*a.y[c]+a.z[c]*a.z[c];for(l=Math.sqrt(l),m=1/l,c=0;g>c;c++)a.x[c]*=m,a.y[c]*=m,a.z[c]*=m;return n.norm},n.evolve=function(o,e,i){var m,u,l,c=i?n.stochGradient.bind(n):n.gradient.bind(n),d=r.atoms,y=d.length,f=12926e-8*y*e,h=Math.ceil(o/100),g=100/o,p={method:"evolve.progress"};for(a.alloc(),i&&s.alloc(),c(),m=0;o>m;m++){for(u=f*n.rootSumSqr/n.sumSqr,l=0;y>l;l++)d[l].x-=u*a.x[l],d[l].y-=u*a.y[l],d[l].z-=u*a.z[l];m%h===0&&(p.data=m*g,t.postMessage(p)),c()}a.dispose(),i&&s.dispose()}}(this);