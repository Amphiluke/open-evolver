!function(e){"use strict";function t(e){var t=e._oid;return i[t]||(t=++o,Object.defineProperty(e,"_oid",{value:t}),i[t]={}),i[t]}var r=e.OE||(e.OE={}),n=r.observer={},i={},o=0;n.on=function(e,r){var n=t(this);n[e]||(n[e]=[]),n[e].push(r)},n.off=function(e,r){var n,i=t(this);i[e]&&(r?(n=i[e].indexOf(r),n>-1&&(i[e].splice(n,1),0===i[e].length&&delete i[e])):(i.length=0,delete i[e]))},n.trigger=function(e){var r,n,i,o,l=t(this);if(l[e]){for(r=Array.prototype.slice.call(arguments,1),n=0,i=l[e].length;i>n;n++)o=l[e][n].apply(null,r);return o}}}(this);
!function(t){"use strict";var e,r=t.OE||(t.OE={}),s=r.utils={};e={H:1.00794,He:4.002602,Li:6.941,Be:9.01218,B:10.811,C:12.011,N:14.0067,O:15.9994,F:18.998403,Ne:20.179,Na:22.98977,Mg:24.305,Al:26.98154,Si:28.0855,P:30.97376,S:32.066,Cl:35.453,Ar:39.948,K:39.0983,Ca:40.078,Sc:44.95591,Ti:47.88,V:50.9415,Cr:51.9961,Mn:54.938,Fe:55.847,Co:58.9332,Ni:58.69,Cu:63.546,Zn:65.39,Ga:69.723,Ge:72.59,As:74.9216,Se:78.96,Br:79.904,Kr:83.8,Rb:85.4678,Sr:87.62,Y:88.9059,Zr:91.224,Nb:92.9064,Mo:95.94,Tc:97.9072,Ru:101.07,Rh:102.9055,Pd:106.42,Ag:107.8682,Cd:112.41,In:114.82,Sn:118.71,Sb:121.75,Te:127.6,I:126.9045,Xe:131.29,Cs:132.9054,Ba:137.33,La:138.9055,Ce:140.12,Pr:140.9077,Nd:144.24,Pm:144.9128,Sm:150.36,Eu:151.96,Gd:157.25,Tb:158.9254,Dy:162.5,Ho:164.9304,Er:167.26,Tm:168.9342,Yb:173.04,Lu:174.967,Hf:178.49,Ta:180.9479,W:183.85,Re:186.207,Os:190.2,Ir:192.22,Pt:195.08,Au:196.9665,Hg:200.59,Tl:204.383,Pb:207.2,Bi:208.9804,Po:208.9824,At:209.9871,Rn:222.0176,Fr:223.0197,Ra:226.0254,Ac:227.0278,Th:232.0381,Pa:231.0359,U:238.0289,Np:237.0482,Pu:244.0642,Am:243.0614,Cm:247.0703,Bk:247.0703,Cf:251.0796,Es:252.0828,Fm:257.0951,Md:258.0986,No:259.1009,Lr:260.1054,Rf:261,Db:262,Sg:263,Bh:262,Hs:265,Mt:266},s.getAtomicMass=function(t){return e[t]},s.getReducedMass=function(t){var e,r,a=t.match(/[A-Z][^A-Z]*/g);if(!a)throw new Error("Cannot extract element labels from string "+t);return e=s.getAtomicMass(a[0]),r=s.getAtomicMass(a[1]),e*r/(e+r)}}(this);
!function(e){"use strict";var t=e.OE,r=t.worker=Object.create(t.observer),a=new e.Worker("src/js/calc.js");r.invoke=function(e,t){a.postMessage({method:e,data:t})},a.addEventListener("error",function(e){throw e}),a.addEventListener("message",function(e){var t=e.data&&e.data.method;t&&r.trigger(t,e.data.data)})}(this);
!function(t){"use strict";var r=t._,e=t.OE,u=e.structureUtils=Object.create(e.observer);e.structure={atoms:[],bonds:[],potentials:{}},u.atomList=[],u.pairList=[],u.overwrite=function(t,r,s){var n,o,i,c,a,l;if(e.structure=t,r!==!1){for(o=u.atomList,i=u.pairList,o.length=i.length=0,n=e.structure.atoms,c=0,l=n.length;l>c;c++)-1===o.indexOf(n[c].el)&&o.push(n[c].el);for(c=0,l=o.length;l>c;c++)for(a=c;l>a;a++)i.push(o[c]+o[a]);u.pairList=i.concat(i.map(function(t){return"x-"+t}))}u.trigger("updateStructure",r!==!1),s!==!0&&u.syncWorker()},u.setPotentials=function(t){var s,n,o,i=e.structure.atoms,c=e.structure.bonds;for(r.each(t,function(t,r){t.b=t.w0*Math.sqrt(e.utils.getReducedMass(r)/t.D0)*.0013559906}),e.structure.potentials=t,n=0,o=c.length;o>n;n++)s="x"===c[n].type?"x-":"",c[n].potential=t[s+i[c[n].iAtm].el+i[c[n].jAtm].el]||t[s+i[c[n].jAtm].el+i[c[n].iAtm].el];u.syncWorker()},u.syncWorker=function(){e.worker.invoke("setStructure",e.structure)},e.worker.on("setStructure",function(t){u.overwrite(t,!1,!0)}),e.worker.on("updateStructure",function(t){u.overwrite(t,!1,!0),e.view.render()})}(this);
!function(t){"use strict";var e=t.OE||(t.OE={}),r=e.fileAPI={},s={};s.hin={parseAtomRecord:function(t){var e=t.split(/\s+/);return{el:e[3],x:+e[7],y:+e[8],z:+e[9]}},parseBonds:function(t){var e,r,s,n,i,o=[];for(r=0,e=t.length;e>r;r++)for(s=t[r].split(/\s+/),i=11,n=2*s[10]+11;n>i;i+=2)s[i]-1>r&&o.push({iAtm:r,jAtm:s[i]-1,type:s[i+1]});return o},parse:function(t){var e=t.match(/^atom\s+\d+\s+.+$/gm);return e&&{atoms:e.map(this.parseAtomRecord,this),bonds:this.parseBonds(e)}}},r.loadHIN=function(t,r){var n=new FileReader;n.addEventListener("load",function(){e.structureUtils.overwrite(s.hin.parse(n.result)),e.view.render(),"function"==typeof r&&r()},!1),n.readAsText(t)}}(this);
!function(e){"use strict";var t=e.THREE,r=e.OE||(e.OE={}),o=r.view={},n={el:null,width:600,height:500},s={currentX:0,startX:0,currentRot:0,startRot:0};o.colors={get:function(e){return this._cache.hasOwnProperty(e)||(this._cache[e]=new t.Color(e)),this._cache[e]}},Object.defineProperty(o.colors,"_cache",{value:{}}),o.presets={C:{color:16711680,radius:1},H:{color:16777215,radius:.7}},Object.defineProperty(o.presets,"_def",{configurable:!0,enumerable:!1,writable:!1,value:o.presets.H}),o.atomMaterials={get:function(e){var r=o.presets[e]||o.presets[e="_def"];return this._cache.hasOwnProperty(e)||(this._cache[e]=new t.MeshLambertMaterial({color:r.color})),this._cache[e]}},Object.defineProperty(o.atomMaterials,"_cache",{value:{}}),o.atomGeometries={get:function(e){var r=o.presets[e]||o.presets[e="_def"];return this._cache.hasOwnProperty(e)||(this._cache[e]=new t.SphereGeometry(r.radius)),this._cache[e]}},Object.defineProperty(o.atomGeometries,"_cache",{value:{}}),o.bondMaterials={basic:new t.LineBasicMaterial({vertexColors:t.VertexColors}),extra:new t.LineDashedMaterial({dashSize:.2,gapSize:.1,vertexColors:t.VertexColors})},o.THREE=function(){var e,r;return e={scene:new t.Scene,group:new t.Object3D,camera:new t.PerspectiveCamera(75,n.width/n.height,.1,1e3),renderer:new t.WebGLRenderer},n.el=e.renderer.domElement,e.scene.add(e.group),r=new t.SpotLight(16777215),r.position.set(-40,60,50),e.scene.add(r,new t.AxisHelper(20)),e.camera.position.x=0,e.camera.position.y=0,e.camera.position.z=10,e.camera.lookAt(e.scene.position),e.renderer.setClearColor(0),e.renderer.setSize(n.width,n.height),e.renderer.render(e.scene,e.camera),document.getElementById("oe-view").appendChild(n.el),e}(),o.render=function(){o.resetScene(),o.update()},o.update=function(){var e=o.THREE.group;e.rotation.y+=.05*(s.currentRot-e.rotation.y),o.THREE.renderer.render(o.THREE.scene,o.THREE.camera),o.autoUpdate&&requestAnimationFrame(o.update)},o.clearScene=function(){for(var e,t=o.THREE.group;e=t.children[0];)t.remove(e)},o.appearance="graph",o.resetScene=function(){o.clearScene(),"spheres"===o.appearance?o.addSceneAtoms():o.addSceneBonds()},o.addSceneAtoms=function(){var e,n,s=t.Mesh,a=o.THREE.group,i=o.atomGeometries,c=o.atomMaterials,u=r.structure.atoms,d=u.length;for(e=0;d>e;e++)n=new s(i.get(u[e].el),c.get(u[e].el)),n.position.x=u[e].x,n.position.y=u[e].y,n.position.z=u[e].z,a.add(n)},o.addSceneBonds=function(){var e,n,s,a=t.Line,i=t.Vector3,c=o.THREE.group,u=o.presets,d=o.colors,p=o.bondMaterials,l=r.structure.atoms,h=r.structure.bonds,m=h.length;for(e=0;m>e;e++)s=new t.Geometry,n=l[h[e].iAtm],s.vertices.push(new i(n.x,n.y,n.z)),s.colors.push(d.get((u[n.el]||u._def).color)),n=l[h[e].jAtm],s.vertices.push(new i(n.x,n.y,n.z)),s.colors.push(d.get((u[n.el]||u._def).color)),"x"===h[e].type?(s.computeLineDistances(),c.add(new a(s,p.extra,t.LineStrip))):c.add(new a(s,p.basic))},o.events={},o.events.mouseDown=function(e){s.startX=e.pageX-(n.width>>1),s.startRot=s.currentRot,n.el.addEventListener("mouseup",this.mouseUp,!1),n.el.addEventListener("mouseout",this.mouseOut,!1),n.el.addEventListener("mousemove",this.mouseMove,!1),o.autoUpdate=!0,o.update()}.bind(o.events),o.events.mouseUp=o.events.mouseOut=function(){o.autoUpdate=!1,n.el.removeEventListener("mouseup",this.mouseUp,!1),n.el.removeEventListener("mouseout",this.mouseOut,!1),n.el.removeEventListener("mousemove",this.mouseMove,!1)}.bind(o.events),o.events.mouseMove=function(e){s.currentX=e.pageX-(n.width>>1),s.currentRot=s.startRot+.02*(s.currentX-s.startX)}.bind(o.events),n.el.addEventListener("mousedown",o.events.mouseDown,!1)}(this);
!function(t){"use strict";var e=t.jQuery,a=t._,n=t.OE,i=n.ui||(n.ui={}),o=e(document);i.$=function(t){return t&&t.jquery?t:e(t)},i.proto={init:function(){var t=this.events||(this.events={});return a.each(t,function(t){var e="string"==typeof t.handler?this[t.handler]:t.handler;i.$(t.owner).on(t.type,t.filter||null,e.bind(this))},this),this}},i.abstractDialog=a.extend(Object.create(i.proto),{init:function(){return this.hasOwnProperty("events")&&(this.events=this.events.concat(i.abstractDialog.events)),i.proto.init.apply(this,arguments)},events:[{type:"click",owner:".oe-apply",handler:"handleApply"},{type:"click",owner:".oe-discard",handler:"handleDiscard"},{type:"keyup",owner:o,handler:"handleGlobalKeyUp"}],handleApply:function(){this.apply(),this.hide()},handleDiscard:function(){this.discard(),this.hide()},handleGlobalKeyUp:function(t){27===t.which&&(this.discard(),this.hide())},apply:e.noop,discard:e.noop,show:function(){this.$el.removeClass("hidden")},hide:function(){this.$el.addClass("hidden")}}),i.graph=a.extend(Object.create(i.abstractDialog),{$el:e(".oe-graph-form"),tpl:a.template(e("#oe-cutoffs-tpl").html()),init:function(){return n.structureUtils.on("updateStructure",function(t){t&&i.graph.resetHTML.call(i.graph)}),i.abstractDialog.init.apply(this,arguments)},events:[{type:"click",owner:".oe-cutoffs",filter:".oe-cutoff",handler:"handlePairSelect"},{type:"change",owner:".oe-cutoff-slider",handler:"handleSliderChange"},{type:"input",owner:"#oe-cutoff-exact",handler:"handleCutoffInput"},{type:"change",owner:"#oe-cutoff-exact",handler:"handleCutoffChange"}],handlePairSelect:function(t){var a=e(t.target),n=a.text().trim();e(t.delegateTarget).find(".oe-cutoff").not(a).removeClass("active"),a.addClass("active"),e("#oe-cutoff-exact").val(n).get(0).select(),e(".oe-cutoff-slider").val(this.cutoff2Slider(+n).toFixed(2))},handleSliderChange:function(t){var a=this.slider2Cutoff(+t.target.value);e("#oe-cutoff-exact").val(a.toFixed(4)).trigger("input"),this.updateGraph(e(".oe-cutoff.active").data("pair"),a)},handleCutoffInput:function(t){e(".oe-cutoff.active").text(t.target.value)},handleCutoffChange:function(t){t.target.checkValidity()&&(e(".oe-cutoff-slider").val(this.cutoff2Slider(+t.target.value).toFixed(2)),this.updateGraph(e(".oe-cutoff.active").data("pair"),+t.target.value))},cutoff2Slider:function(t){var a=e(".oe-cutoff-slider")[0],n=+e("#oe-cutoff-min").val(),i=+e("#oe-cutoff-max").val(),o=+a.min,r=+a.max;return o+(t-n)*(r-o)/(i-n)},slider2Cutoff:function(t){var a=e(".oe-cutoff-slider")[0],n=+e("#oe-cutoff-min").val(),i=+e("#oe-cutoff-max").val(),o=+a.min,r=+a.max;return n+(t-o)*(i-n)/(r-o)},resetHTML:function(){this.$el.find(".oe-cutoffs").html(this.tpl({pairs:n.structureUtils.pairList.slice(0,n.structureUtils.pairList.length/2)})).find(".oe-cutoff").eq(0).addClass("active")},updateGraph:function(t,e){n.worker.invoke("reconnectPairs",{pair:t,cutoff:e})}}).init(),i.potentials=a.extend(Object.create(i.abstractDialog),{$el:e(".oe-potential-form"),tpl:a.template(e("#oe-potentials-tpl").html()),init:function(){return n.structureUtils.on("updateStructure",function(t){t&&i.potentials.resetHTML.call(i.potentials)}),i.abstractDialog.init.apply(this,arguments)},events:[{type:"change",owner:".load-potentials",handler:"handleLoad"},{type:"mousedown",owner:".save-potentials",handler:"handleSave"}],handleLoad:function(t){var e=new FileReader;e.addEventListener("load",function(){var t=e.result.split(/\r?\n/);a.each(t,function(t){var e=t.split("	");i.potentials.$el.find("li[data-pair='"+e[0]+"'] input").val(function(t){return e[t+1]||""})})},!1),e.readAsText(t.target.files[0])},handleSave:function(t){var a=this.$el.find("li[data-pair]").map(function(){var t=e(this);return t.data("pair")+"	"+t.find("input").map(function(){return this.value}).get().join("	")}).get().join("\r\n");t.target.href="data:text/plain;base64,"+btoa(a)},handleApply:function(){return this.$el[0].checkValidity()?i.abstractDialog.handleApply.apply(this,arguments):void window.alert("Please, fix invalid input first")},resetHTML:function(){this.$el.find("ul.oe-potentials").html(this.tpl({pairs:n.structureUtils.pairList}))},apply:function(){var t={};this.$el.find("li[data-pair]").each(function(){var a=e(this),n={};a.find("input[data-param]").each(function(){return this.value?(n[e(this).data("param")]=+this.value,void(this.defaultValue=this.value)):n=!1}),n&&(t[a.data("pair")]=n)}),n.structureUtils.setPotentials(t)},discard:function(){this.$el[0].reset()},show:function(){var t,a,o,r,l=n.structure.atoms,c=n.structure.bonds,s=c.length,u=[];for(r=0;s>r;r++)t="x"===c[r].type?"x-":"",a=l[c[r].iAtm].el,o=l[c[r].jAtm].el,-1===u.indexOf(t+a+o)&&(u.push(t+a+o),a!==o&&u.push(t+o+a));return this.$el.find("li[data-pair]").each(function(){var t=e(this);t.toggleClass("missed",-1===u.indexOf(t.data("pair")))}),i.abstractDialog.show.apply(this,arguments)}}).init(),i.appearance=a.extend(Object.create(i.abstractDialog),{$el:e(".oe-appearance-form"),apply:function(){var t=this.$el.find("input[name='appearance']").filter(":checked").data("appearance");t!==n.view.appearance&&(n.view.appearance=t,n.view.render())},discard:function(){this.$el.find("input[data-appearance='"+n.view.appearance+"']").prop("checked",!0)}}).init(),i.info=a.extend(Object.create(i.abstractDialog),{$el:e(".oe-info-dialog"),init:function(){var t=this.tpls={};return this.$el.find("script[type='text/template'][data-info]").each(function(){var n=e(this);t[n.data("info")]=a.template(n.html())}),i.abstractDialog.init.apply(this,arguments)},applyTpl:function(t,e){this.$el.find(".oe-info-dialog-text").html(this.tpls[t](e))}}).init(),i.menu=a.extend(Object.create(i.proto),{$el:e(".oe-menu"),events:[{type:"click.oe",owner:o,handler:"handleGlobalClick"},{type:"mouseenter",owner:".oe-menu",filter:"button[menu]",handler:"handleHover"},{type:"click",owner:".oe-menu",filter:"menuitem[data-action]",handler:"handleAction"},{type:"change",owner:"#oe-file",handler:"handleFile"}],handleGlobalClick:function(t){var a=e(t.target),n=this.$el.find("menu.expanded");a.is(".oe-menu button[menu]")&&(n=n.not(e("#"+a.attr("menu")).toggleClass("expanded"))),n.removeClass("expanded")},handleHover:function(t){var a,n=this.$el.find("menu.expanded");n.length&&(a=e(t.target).siblings("menu"),n.is(a)||(n.removeClass("expanded"),a.addClass("expanded")))},handleAction:function(t){var a=e(t.target).data("action")+"Action";"function"==typeof this[a]&&this[a]()},handleFile:function(t){n.fileAPI.loadHIN(t.target.files[0])},loadAction:function(){e("#oe-file").trigger("click")},saveAction:function(){},alterGraphAction:function(){i.graph.show()},setupAction:function(){i.potentials.show()},calcEnergyAction:function(){n.worker.invoke("totalEnergy")},calcGradAction:function(){n.worker.invoke("gradient")},alterViewAction:function(){i.appearance.show()}}).init(),n.worker.on("totalEnergy",function(t){i.info.applyTpl("energy",{energy:t,bonds:n.structure.bonds.length}),i.info.show()}),n.worker.on("gradient",function(t){i.info.applyTpl("gradient",{grad:t}),i.info.show()})}(this);